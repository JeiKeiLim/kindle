<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../img/favicon.ico">
    <title>Functionality &mdash; Kindle</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/tonsky/FiraCode@1.206/distr/fira_code.css">
    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.8.1/css/all.css">
    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.8.1/css/v4-shims.css">
    <link rel="stylesheet" href="../css/theme.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
    <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
    </script> 
</head>

<body ontouchstart="">
    <div id="container">
        <aside>
            <div class="home">
                <div class="title">
                    <button class="hamburger"></button>
                    <a href=".." class="site-name"> Kindle</a>
                </div>
                <div class="search">
                    <div role="search">
    <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
        <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
    </form>
</div>
                </div>
            </div>
            <nav class="nav">
                <ul class="root">
                    <li class="toctree-l1"><a class="nav-item" href="..">Home</a></li>
                    <li class="toctree-l1 current"><a class="nav-item current" href="./">Functionality</a>
<ul class="subnav">
<li class="toctree-l2"><a class="nav-item toc" href="#1-model-profiling">1. Model Profiling</a></li>
<li class="toctree-l2"><a class="nav-item toc" href="#2-get-macs">2. Get MACs</a></li>
<li class="toctree-l2"><a class="nav-item toc" href="#3-test-time-augmentation">3. Test Time Augmentation</a></li>
</ul></li>
                    <li class="toctree-l1"><a class="nav-item" href="../tutorial/">Tutorial</a></li>
                    <li class="toctree-l1"><a class="nav-item" href="../usages/">Usages</a></li>
                    <li class="toctree-l1"><a class="nav-item" href="../modules/">Modules</a></li>
                </ul>
            </nav>
            <div class="repo">
    <div class="link">
        <a href="https://github.com/JeiKeiLim/kindle/" class="fa fa-github"> GitHub</a>
    </div>
    <div class="previous"><a href="..">&laquo; Previous</a></div>
    <div class="next"><a href="../tutorial/">Next &raquo;</a></div>
</div>
        </aside>
        <div id="spacer"><button class="arrow"></button></div>
        <main>
            <div class="home-top">
                <button class="hamburger"></button>
                <a href=".." class="site-name"> Kindle</a>
            </div>
            <div id="main">
                <nav class="breadcrumbs">
<ul>
    
</ul>
</nav>
                <div id="content"><h1 id="functionalities">Functionalities</h1>
<h2 id="1-model-profiling">1. Model Profiling</h2>
<h3 id="basic-profiling">Basic profiling</h3>
<ul>
<li>Kindle model provides profiling option.</li>
<li>Please refer to <a href="https://limjk.ai/kindle/api/kindle.utils.model_utils/#kindleutilsmodel_utilsmodelprofiler">API reference page</a> for the detailed information.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">kindle</span> <span class="kn">import</span> <span class="n">Model</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="s2">&quot;model.yaml&quot;</span><span class="p">)</span>

<span class="n">profiler</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">n_run</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>Above code will print the profiling result as following.</li>
</ul>
<div class="highlight"><pre><span></span><code>Profiling result by <span class="m">100</span> <span class="nb">times</span> running. Sorted by running order.
------------------------------------------------------------------------------------------------------
 idx <span class="p">|</span>                 Name <span class="p">|</span> Time<span class="o">(</span>Mean<span class="o">)</span> <span class="p">|</span>  Time<span class="o">(</span>Std<span class="o">)</span> <span class="p">|</span> Time<span class="o">(</span>Total<span class="o">)</span> <span class="p">|</span> Rank <span class="p">|</span>   Ratio <span class="p">|</span>        Params <span class="p">|</span>
------------------------------------------------------------------------------------------------------
   <span class="m">0</span> <span class="p">|</span>                 Conv <span class="p">|</span>    <span class="m">1</span>.40 ms <span class="p">|</span>  <span class="m">566</span>.86 μs <span class="p">|</span>   <span class="m">139</span>.69 ms <span class="p">|</span>    <span class="m">1</span> <span class="p">|</span>  <span class="m">36</span>.08% <span class="p">|</span>           <span class="m">616</span> <span class="p">|</span>
   <span class="m">1</span> <span class="p">|</span>              MaxPool <span class="p">|</span>  <span class="m">410</span>.78 μs <span class="p">|</span>  <span class="m">136</span>.45 μs <span class="p">|</span>    <span class="m">41</span>.08 ms <span class="p">|</span>    <span class="m">3</span> <span class="p">|</span>  <span class="m">10</span>.61% <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
   <span class="m">2</span> <span class="p">|</span>            nn.Conv2d <span class="p">|</span>  <span class="m">980</span>.33 μs <span class="p">|</span>  <span class="m">459</span>.86 μs <span class="p">|</span>    <span class="m">98</span>.03 ms <span class="p">|</span>    <span class="m">2</span> <span class="p">|</span>  <span class="m">25</span>.32% <span class="p">|</span>         <span class="m">3</span>,200 <span class="p">|</span>
   <span class="m">3</span> <span class="p">|</span>       nn.BatchNorm2d <span class="p">|</span>  <span class="m">277</span>.48 μs <span class="p">|</span>  <span class="m">141</span>.98 μs <span class="p">|</span>    <span class="m">27</span>.75 ms <span class="p">|</span>    <span class="m">5</span> <span class="p">|</span>   <span class="m">7</span>.17% <span class="p">|</span>            <span class="m">32</span> <span class="p">|</span>
   <span class="m">4</span> <span class="p">|</span>              nn.ReLU <span class="p">|</span>  <span class="m">109</span>.23 μs <span class="p">|</span>   <span class="m">43</span>.48 μs <span class="p">|</span>    <span class="m">10</span>.92 ms <span class="p">|</span>    <span class="m">7</span> <span class="p">|</span>   <span class="m">2</span>.82% <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
   <span class="m">5</span> <span class="p">|</span>              MaxPool <span class="p">|</span>  <span class="m">242</span>.73 μs <span class="p">|</span>   <span class="m">80</span>.28 μs <span class="p">|</span>    <span class="m">24</span>.27 ms <span class="p">|</span>    <span class="m">6</span> <span class="p">|</span>   <span class="m">6</span>.27% <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
   <span class="m">6</span> <span class="p">|</span>              Flatten <span class="p">|</span>   <span class="m">18</span>.18 μs <span class="p">|</span>   <span class="m">16</span>.98 μs <span class="p">|</span>     <span class="m">1</span>.82 ms <span class="p">|</span>   <span class="m">10</span> <span class="p">|</span>   <span class="m">0</span>.47% <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
   <span class="m">7</span> <span class="p">|</span>               Linear <span class="p">|</span>  <span class="m">294</span>.72 μs <span class="p">|</span>  <span class="m">192</span>.97 μs <span class="p">|</span>    <span class="m">29</span>.47 ms <span class="p">|</span>    <span class="m">4</span> <span class="p">|</span>   <span class="m">7</span>.61% <span class="p">|</span>       <span class="m">123</span>,000 <span class="p">|</span>
   <span class="m">8</span> <span class="p">|</span>               Linear <span class="p">|</span>   <span class="m">94</span>.48 μs <span class="p">|</span>   <span class="m">44</span>.85 μs <span class="p">|</span>     <span class="m">9</span>.45 ms <span class="p">|</span>    <span class="m">8</span> <span class="p">|</span>   <span class="m">2</span>.44% <span class="p">|</span>        <span class="m">10</span>,164 <span class="p">|</span>
   <span class="m">9</span> <span class="p">|</span>               Linear <span class="p">|</span>   <span class="m">46</span>.44 μs <span class="p">|</span>   <span class="m">26</span>.23 μs <span class="p">|</span>     <span class="m">4</span>.64 ms <span class="p">|</span>    <span class="m">9</span> <span class="p">|</span>   <span class="m">1</span>.20% <span class="p">|</span>           <span class="m">850</span> <span class="p">|</span>
------------------------------------------------------------------------------------------------------
Running <span class="nb">time</span>
 - Total :   <span class="m">387</span>.13 ms
 -  Mean :     <span class="m">3</span>.87 ms
 -   STD :     <span class="m">1</span>.45 ms
</code></pre></div>
<h3 id="profiling-by-time-consumption-order">Profiling by time consumption order</h3>
<ul>
<li>Profiling result can be sorted by running times.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">profiler</span><span class="o">.</span><span class="n">print_result</span><span class="p">(</span><span class="n">sort_by_rank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Profiling result by <span class="m">100</span> <span class="nb">times</span> running. Sorted by <span class="nb">time</span> consumption.
------------------------------------------------------------------------------------------------------
 idx <span class="p">|</span>                 Name <span class="p">|</span> Time<span class="o">(</span>Mean<span class="o">)</span> <span class="p">|</span>  Time<span class="o">(</span>Std<span class="o">)</span> <span class="p">|</span> Time<span class="o">(</span>Total<span class="o">)</span> <span class="p">|</span> Rank <span class="p">|</span>   Ratio <span class="p">|</span>        Params <span class="p">|</span>
------------------------------------------------------------------------------------------------------
   <span class="m">0</span> <span class="p">|</span>                 Conv <span class="p">|</span>    <span class="m">1</span>.40 ms <span class="p">|</span>  <span class="m">566</span>.86 μs <span class="p">|</span>   <span class="m">139</span>.69 ms <span class="p">|</span>    <span class="m">1</span> <span class="p">|</span>  <span class="m">36</span>.08% <span class="p">|</span>           <span class="m">616</span> <span class="p">|</span>
   <span class="m">2</span> <span class="p">|</span>            nn.Conv2d <span class="p">|</span>  <span class="m">980</span>.33 μs <span class="p">|</span>  <span class="m">459</span>.86 μs <span class="p">|</span>    <span class="m">98</span>.03 ms <span class="p">|</span>    <span class="m">2</span> <span class="p">|</span>  <span class="m">25</span>.32% <span class="p">|</span>         <span class="m">3</span>,200 <span class="p">|</span>
   <span class="m">1</span> <span class="p">|</span>              MaxPool <span class="p">|</span>  <span class="m">410</span>.78 μs <span class="p">|</span>  <span class="m">136</span>.45 μs <span class="p">|</span>    <span class="m">41</span>.08 ms <span class="p">|</span>    <span class="m">3</span> <span class="p">|</span>  <span class="m">10</span>.61% <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
   <span class="m">7</span> <span class="p">|</span>               Linear <span class="p">|</span>  <span class="m">294</span>.72 μs <span class="p">|</span>  <span class="m">192</span>.97 μs <span class="p">|</span>    <span class="m">29</span>.47 ms <span class="p">|</span>    <span class="m">4</span> <span class="p">|</span>   <span class="m">7</span>.61% <span class="p">|</span>       <span class="m">123</span>,000 <span class="p">|</span>
   <span class="m">3</span> <span class="p">|</span>       nn.BatchNorm2d <span class="p">|</span>  <span class="m">277</span>.48 μs <span class="p">|</span>  <span class="m">141</span>.98 μs <span class="p">|</span>    <span class="m">27</span>.75 ms <span class="p">|</span>    <span class="m">5</span> <span class="p">|</span>   <span class="m">7</span>.17% <span class="p">|</span>            <span class="m">32</span> <span class="p">|</span>
   <span class="m">5</span> <span class="p">|</span>              MaxPool <span class="p">|</span>  <span class="m">242</span>.73 μs <span class="p">|</span>   <span class="m">80</span>.28 μs <span class="p">|</span>    <span class="m">24</span>.27 ms <span class="p">|</span>    <span class="m">6</span> <span class="p">|</span>   <span class="m">6</span>.27% <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
   <span class="m">4</span> <span class="p">|</span>              nn.ReLU <span class="p">|</span>  <span class="m">109</span>.23 μs <span class="p">|</span>   <span class="m">43</span>.48 μs <span class="p">|</span>    <span class="m">10</span>.92 ms <span class="p">|</span>    <span class="m">7</span> <span class="p">|</span>   <span class="m">2</span>.82% <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
   <span class="m">8</span> <span class="p">|</span>               Linear <span class="p">|</span>   <span class="m">94</span>.48 μs <span class="p">|</span>   <span class="m">44</span>.85 μs <span class="p">|</span>     <span class="m">9</span>.45 ms <span class="p">|</span>    <span class="m">8</span> <span class="p">|</span>   <span class="m">2</span>.44% <span class="p">|</span>        <span class="m">10</span>,164 <span class="p">|</span>
   <span class="m">9</span> <span class="p">|</span>               Linear <span class="p">|</span>   <span class="m">46</span>.44 μs <span class="p">|</span>   <span class="m">26</span>.23 μs <span class="p">|</span>     <span class="m">4</span>.64 ms <span class="p">|</span>    <span class="m">9</span> <span class="p">|</span>   <span class="m">1</span>.20% <span class="p">|</span>           <span class="m">850</span> <span class="p">|</span>
   <span class="m">6</span> <span class="p">|</span>              Flatten <span class="p">|</span>   <span class="m">18</span>.18 μs <span class="p">|</span>   <span class="m">16</span>.98 μs <span class="p">|</span>     <span class="m">1</span>.82 ms <span class="p">|</span>   <span class="m">10</span> <span class="p">|</span>   <span class="m">0</span>.47% <span class="p">|</span>             <span class="m">0</span> <span class="p">|</span>
------------------------------------------------------------------------------------------------------
Running <span class="nb">time</span>
 - Total :   <span class="m">387</span>.13 ms
 -  Mean :     <span class="m">3</span>.87 ms
 -   STD :     <span class="m">1</span>.45 ms
</code></pre></div>
<h2 id="2-get-macs">2. Get MACs</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Multiply–accumulate_operation">MACs</a> is Multiply-accumulate operation which represents computational expense.</li>
<li>Approximately 1 MACs = 0.5 * FLOPs</li>
<li>Kindle is using <a href="https://github.com/sovrasov/flops-counter.pytorch">ptflops</a> for computing MACs.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">mac</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">get_macs</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mac</span><span class="si">:</span><span class="s2">,0d</span><span class="si">}</span><span class="s2"> MACs&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Model<span class="o">(</span>
  <span class="m">0</span>.138 M, <span class="m">100</span>.000% Params, <span class="m">0</span>.002 GMac, <span class="m">100</span>.000% MACs, 
  <span class="o">(</span>model<span class="o">)</span>: Sequential<span class="o">(</span>
    <span class="m">0</span>.138 M, <span class="m">100</span>.000% Params, <span class="m">0</span>.002 GMac, <span class="m">100</span>.000% MACs, 
    <span class="o">(</span><span class="m">0</span><span class="o">)</span>: Conv<span class="o">(</span>
      <span class="m">0</span>.001 M, <span class="m">0</span>.447% Params, <span class="m">0</span>.001 GMac, <span class="m">39</span>.517% MACs, 
      <span class="o">(</span>conv<span class="o">)</span>: Conv2d<span class="o">(</span><span class="m">0</span>.001 M, <span class="m">0</span>.435% Params, <span class="m">0</span>.001 GMac, <span class="m">37</span>.997% MACs, <span class="m">3</span>, <span class="m">8</span>, <span class="nv">kernel_size</span><span class="o">=(</span><span class="m">5</span>, <span class="m">5</span><span class="o">)</span>, <span class="nv">stride</span><span class="o">=(</span><span class="m">1</span>, <span class="m">1</span><span class="o">)</span>, <span class="nv">padding</span><span class="o">=[</span><span class="m">2</span><span class="o">]</span>, <span class="nv">bias</span><span class="o">=</span>False<span class="o">)</span>
      <span class="o">(</span>batch_norm<span class="o">)</span>: BatchNorm2d<span class="o">(</span><span class="m">0</span>.0 M, <span class="m">0</span>.012% Params, <span class="m">0</span>.0 GMac, <span class="m">1</span>.013% MACs, <span class="m">8</span>, <span class="nv">eps</span><span class="o">=</span>1e-05, <span class="nv">momentum</span><span class="o">=</span><span class="m">0</span>.1, <span class="nv">affine</span><span class="o">=</span>True, <span class="nv">track_running_stats</span><span class="o">=</span>True<span class="o">)</span>
      <span class="o">(</span>activation<span class="o">)</span>: LeakyReLU<span class="o">(</span><span class="m">0</span>.0 M, <span class="m">0</span>.000% Params, <span class="m">0</span>.0 GMac, <span class="m">0</span>.507% MACs, <span class="nv">negative_slope</span><span class="o">=</span><span class="m">0</span>.01<span class="o">)</span>
    <span class="o">)</span>
    <span class="o">(</span><span class="m">1</span><span class="o">)</span>: MaxPool2d<span class="o">(</span><span class="m">0</span>.0 M, <span class="m">0</span>.000% Params, <span class="m">0</span>.0 GMac, <span class="m">0</span>.507% MACs, <span class="nv">kernel_size</span><span class="o">=</span><span class="m">2</span>, <span class="nv">stride</span><span class="o">=</span><span class="m">2</span>, <span class="nv">padding</span><span class="o">=</span><span class="m">0</span>, <span class="nv">dilation</span><span class="o">=</span><span class="m">1</span>, <span class="nv">ceil_mode</span><span class="o">=</span>False<span class="o">)</span>
    <span class="o">(</span><span class="m">2</span><span class="o">)</span>: Conv2d<span class="o">(</span><span class="m">0</span>.003 M, <span class="m">2</span>.321% Params, <span class="m">0</span>.001 GMac, <span class="m">50</span>.663% MACs, <span class="m">8</span>, <span class="m">16</span>, <span class="nv">kernel_size</span><span class="o">=(</span><span class="m">5</span>, <span class="m">5</span><span class="o">)</span>, <span class="nv">stride</span><span class="o">=(</span><span class="m">1</span>, <span class="m">1</span><span class="o">)</span>, <span class="nv">padding</span><span class="o">=(</span><span class="m">2</span>, <span class="m">2</span><span class="o">)</span>, <span class="nv">bias</span><span class="o">=</span>False<span class="o">)</span>
    <span class="o">(</span><span class="m">3</span><span class="o">)</span>: BatchNorm2d<span class="o">(</span><span class="m">0</span>.0 M, <span class="m">0</span>.023% Params, <span class="m">0</span>.0 GMac, <span class="m">0</span>.507% MACs, <span class="m">16</span>, <span class="nv">eps</span><span class="o">=</span>1e-05, <span class="nv">momentum</span><span class="o">=</span><span class="m">0</span>.1, <span class="nv">affine</span><span class="o">=</span>True, <span class="nv">track_running_stats</span><span class="o">=</span>True<span class="o">)</span>
    <span class="o">(</span><span class="m">4</span><span class="o">)</span>: ReLU<span class="o">(</span><span class="m">0</span>.0 M, <span class="m">0</span>.000% Params, <span class="m">0</span>.0 GMac, <span class="m">0</span>.253% MACs, <span class="nv">inplace</span><span class="o">=</span>True<span class="o">)</span>
    <span class="o">(</span><span class="m">5</span><span class="o">)</span>: MaxPool2d<span class="o">(</span><span class="m">0</span>.0 M, <span class="m">0</span>.000% Params, <span class="m">0</span>.0 GMac, <span class="m">0</span>.253% MACs, <span class="nv">kernel_size</span><span class="o">=</span><span class="m">2</span>, <span class="nv">stride</span><span class="o">=</span><span class="m">2</span>, <span class="nv">padding</span><span class="o">=</span><span class="m">0</span>, <span class="nv">dilation</span><span class="o">=</span><span class="m">1</span>, <span class="nv">ceil_mode</span><span class="o">=</span>False<span class="o">)</span>
    <span class="o">(</span><span class="m">6</span><span class="o">)</span>: Flatten<span class="o">(</span><span class="m">0</span>.0 M, <span class="m">0</span>.000% Params, <span class="m">0</span>.0 GMac, <span class="m">0</span>.000% MACs, <span class="nv">start_dim</span><span class="o">=</span><span class="m">1</span>, <span class="nv">end_dim</span><span class="o">=</span>-1<span class="o">)</span>
    <span class="o">(</span><span class="m">7</span><span class="o">)</span>: Linear<span class="o">(</span>
      <span class="m">0</span>.123 M, <span class="m">89</span>.220% Params, <span class="m">0</span>.0 GMac, <span class="m">7</span>.614% MACs, 
      <span class="o">(</span>linear<span class="o">)</span>: Linear<span class="o">(</span><span class="m">0</span>.123 M, <span class="m">89</span>.220% Params, <span class="m">0</span>.0 GMac, <span class="m">7</span>.607% MACs, <span class="nv">in_features</span><span class="o">=</span><span class="m">1024</span>, <span class="nv">out_features</span><span class="o">=</span><span class="m">120</span>, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
      <span class="o">(</span>activation<span class="o">)</span>: ReLU<span class="o">(</span><span class="m">0</span>.0 M, <span class="m">0</span>.000% Params, <span class="m">0</span>.0 GMac, <span class="m">0</span>.007% MACs, <span class="o">)</span>
    <span class="o">)</span>
    <span class="o">(</span><span class="m">8</span><span class="o">)</span>: Linear<span class="o">(</span>
      <span class="m">0</span>.01 M, <span class="m">7</span>.373% Params, <span class="m">0</span>.0 GMac, <span class="m">0</span>.634% MACs, 
      <span class="o">(</span>linear<span class="o">)</span>: Linear<span class="o">(</span><span class="m">0</span>.01 M, <span class="m">7</span>.373% Params, <span class="m">0</span>.0 GMac, <span class="m">0</span>.629% MACs, <span class="nv">in_features</span><span class="o">=</span><span class="m">120</span>, <span class="nv">out_features</span><span class="o">=</span><span class="m">84</span>, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
      <span class="o">(</span>activation<span class="o">)</span>: ReLU<span class="o">(</span><span class="m">0</span>.0 M, <span class="m">0</span>.000% Params, <span class="m">0</span>.0 GMac, <span class="m">0</span>.005% MACs, <span class="o">)</span>
    <span class="o">)</span>
    <span class="o">(</span><span class="m">9</span><span class="o">)</span>: Linear<span class="o">(</span>
      <span class="m">0</span>.001 M, <span class="m">0</span>.617% Params, <span class="m">0</span>.0 GMac, <span class="m">0</span>.053% MACs, 
      <span class="o">(</span>linear<span class="o">)</span>: Linear<span class="o">(</span><span class="m">0</span>.001 M, <span class="m">0</span>.617% Params, <span class="m">0</span>.0 GMac, <span class="m">0</span>.053% MACs, <span class="nv">in_features</span><span class="o">=</span><span class="m">84</span>, <span class="nv">out_features</span><span class="o">=</span><span class="m">10</span>, <span class="nv">bias</span><span class="o">=</span>True<span class="o">)</span>
      <span class="o">(</span>activation<span class="o">)</span>: Identity<span class="o">(</span><span class="m">0</span>.0 M, <span class="m">0</span>.000% Params, <span class="m">0</span>.0 GMac, <span class="m">0</span>.000% MACs, <span class="o">)</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">)</span>
<span class="m">1</span>,616,970 MACs
</code></pre></div>
<h2 id="3-test-time-augmentation">3. Test Time Augmentation</h2>
<ul>
<li>Kindle model supports TTA with simple usage.</li>
<li>Reference document: <a href="https://limjk.ai/kindle/api/kindle.model/#kindle.model.Model.forward">https://limjk.ai/kindle/api/kindle.model/#kindle.model.Model.forward</a></li>
</ul>
<h3 id="tta-with-explicit-functions">TTA with explicit functions</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">kindle</span> <span class="kn">import</span> <span class="n">Model</span>


<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">aug_flip_lr</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">aug_flip_ud</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

<span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">aug_random_scale</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
    <span class="n">xr</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="n">ratio</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
        <span class="n">h1</span><span class="p">,</span> <span class="n">w1</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">h2</span><span class="p">,</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

        <span class="n">xr</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">xr</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">w1</span> <span class="o">-</span> <span class="n">w2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h1</span> <span class="o">-</span> <span class="n">h2</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xr</span>

<span class="n">aug_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">aug_flip_lr</span><span class="p">,</span> <span class="n">aug_flip_ud</span><span class="p">,</span> <span class="n">aug_random_scale</span><span class="p">]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="s2">&quot;model.yaml&quot;</span><span class="p">)</span>

<span class="n">model_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="n">model_out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">model_in</span><span class="p">,</span> <span class="n">augment_func</span><span class="o">=</span><span class="n">aug_funcs</span><span class="p">)</span>
</code></pre></div>
<ul>
<li><code>model_out</code> in the above code contains <strong>4</strong> elements which are outputs of the model with each 3 augmentations and original <code>model_in</code>.</li>
</ul>
<h3 id="tta-with-repeating-one-augmentation-function">TTA with repeating one augmentation function</h3>
<ul>
<li>If a single augmentation function is given to <code>augment_func</code>, TTA will consider as random augmentation and run the network repeating <code>n_augment</code> times. </li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">model_out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">model_in</span><span class="p">,</span> <span class="n">augment_func</span><span class="o">=</span><span class="n">aug_random_scale</span><span class="p">,</span> <span class="n">n_augment</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<ul>
<li><code>model_out</code> in the above code contains <strong>6</strong> elements which are outputs of the model with 5 <code>aug_random_scale</code> applied and original <code>model_in</code>.</li>
</ul></div>
                <footer>
    <div class="footer-buttons">
        <div class="previous"><a href=".." title="Home"><span>Previous</span></a></div>
        <div class="next"><a href="../tutorial/" title="Tutorial"><span>Next</span></a></div>
    </div>
    <div class="footer-note">
        <p>
            Built with <a href="http://www.mkdocs.org">MkDocs</a> using
            <a href="https://github.com/daizutabi/mkdocs-ivory">Ivory theme</a>.
        </p>
    </div>
</footer>
            </div>
        </main>
    </div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
    <script src="../search/main.js"></script>
</body>

</html>